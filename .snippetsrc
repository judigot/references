#!/bin/bash

helloWorld() {
    local user=${USER:-$USERNAME}  # Use $USER if available, otherwise fallback to $USERNAME
    echo -e "\e[32mHello, $user!\e[0m"  # Green
}
alias hi='helloWorld'
alias hello='helloWorld'
alias helloworld='helloWorld'

updateCurrentBranch() {
    git merge origin/main
    git push
}
alias git-updatecurrentbranch='updateCurrentBranch'
alias git-mergemaintocurrentbranch='updateCurrentBranch'
alias git-getupdatesfrommain='updateCurrentBranch'

updateRCFiles() {
    curl -sL https://raw.githubusercontent.com/judigot/references/main/.bashrc -o "$HOME/.bashrc" || { echo "Failed to download .bashrc"; return 1; }
    curl -sL https://raw.githubusercontent.com/judigot/references/main/.zshrc -o "$HOME/.zshrc" || { echo "Failed to download .zshrc"; return 1; }
    curl -sL https://raw.githubusercontent.com/judigot/references/main/.snippetsrc -o "$HOME/.snippetsrc" || { echo "Failed to download .snippetsrc"; return 1; }

    # Source the appropriate configuration based on the current shell
    if [[ "$0" == *"zsh"* ]]; then
        [[ -f "$HOME/.zshrc" ]] && source "$HOME/.zshrc"
    elif [[ "$0" == *"bash"* ]]; then
        [[ -f "$HOME/.bashrc" ]] && source "$HOME/.bashrc"
    fi

    # Source the shared snippets configuration
    [[ -f "$HOME/.snippetsrc" ]] && source "$HOME/.snippetsrc"
    
    echo "Configuration files updated and sourced successfully."
    return 0
}

alias updater='updateRCFiles'
alias updaterc='updateRCFiles'
alias updateenv='updateRCFiles'
alias updatercfiles='updateRCFiles'
alias updatebashsnippets='updateRCFiles'

bigBangVite() {
    curl -L "https://raw.githubusercontent.com/judigot/references/main/BigBangVite.sh" | bash
}
alias bbvite='bigBangVite'
alias bigbangvite='bigBangVite'
alias newprojectvite='bigBangVite'

bigBangLaravel() {
    curl -L "https://raw.githubusercontent.com/judigot/references/main/BigBangLaravel.sh" | bash
}
alias bblaravel='bigBangLaravel'
alias bigbanglaravel='bigBangLaravel'
alias newprojectlaravel='bigBangLaravel'

logSSH() {
    echo -e "Copy and paste the public key below to your GitHub account:\n\n\e[32m$(cat ~/.ssh/id_ed25519.pub) \e[0m\n" # Green
}
alias logssh='logSSH'
alias logsshkey='logSSH'
alias echossh='logSSH'
alias echosshkey='logSSH'
alias getssh='logSSH'
alias getsshkey='logSSH'

generateSSHKey() {
    ssh-keygen -t rsa -f ~/.ssh/id_ed25519 -P "" && clear && logSSH
    ssh-keygen -t rsa -f ~/.ssh/id_ed25519 -P "" && chmod 600 ~/.ssh/id_ed25519 && clear && echossh
}
alias makesshkey='generateSSHKey'
alias createsshkey='generateSSHKey'
alias generatesshkey='generateSSHKey'
alias generatessh='generateSSHKey'

testSSH() {
    ssh -T git@github.com -o StrictHostKeyChecking=no
}
alias testssh='testSSH'
alias checkssh='testSSH'

useSSHKey() {
  key="$1"

  # Start agent if needed
  if [ -z "${SSH_AUTH_SOCK:-}" ] || ! ssh-add -l >/dev/null 2>&1; then
    eval "$(ssh-agent -s)" >/dev/null
  fi

  # Reset keys, then add personal
  ssh-add -D >/dev/null 2>&1 || true
  ssh-add "$HOME/.ssh/$key"

  # Quick confirmation
  ssh-add -l
}

usePersonalSSH() { useSSHKey "id_ed25519"; }
alias usepersonalssh='usePersonalSSH'
alias personalssh='usePersonalSSH'

useWorkSSH() { useSSHKey "id_ed25519_work"; }
alias useworkssh='useWorkSSH'
alias workssh='useWorkSSH'

deleteAll() {
    read -rp 'Are you sure you want to delete everything? (y/N) ' confirm
    [ "$confirm" = 'y' ] && rm -rf .[!.]* *
}
alias deleteall="deleteAll"
alias deleteeverything="deleteAll"

loadSnippets() {
    grep -q '#<SNIPPETS>' "$HOME/.bashrc" 2>/dev/null || printf '%s\n' '#<SNIPPETS>' '[[ -f "$HOME/.snippetsrc" ]] && source "$HOME/.snippetsrc"' '#<SNIPPETS/>' >> "$HOME/.bashrc"
}
alias loadsnippets='loadSnippets'
alias loadsnippetsrc='loadSnippets'
alias usesnippets='loadSnippets'
alias usesnippetssrc='loadSnippets'

claude() {
    # Install claude-code if not installed
    if ! command -v claude >/dev/null 2>&1; then
        npm install -g @anthropic-ai/claude-code
    fi

    # Clone or pull ai directory
    if [ ! -d ~/ai ]; then
        git clone git@github.com:judigot/ai.git ~/ai >/dev/null 2>&1
    else
        git -C ~/ai pull >/dev/null 2>&1
    fi

    command claude --plugin-dir ~/ai --plugin-dir . "$@"
}

addCursorBoilerplate() {
    mkdir -p .cursor/rules/global-agents
    mkdir -p .cursor/rules/project-agents
    mkdir -p agents

    cat > .cursor/rules/global-agents/RULE.md << 'EOF'
---
description: Global AI agents, skills, and settings from ~/ai repository
globs:
alwaysApply: true
---

# Global AI Configuration

Loads shared agents, skills, and coding standards from `~/ai`.

## Agents & Skills

@~/ai/README.md

## Coding Standards

@~/ai/settings/rules.md
EOF

    cat > .cursor/rules/project-agents/RULE.md << 'EOF'
---
description: Project-specific agents defined in agents/ directory
globs:
alwaysApply: false
---

# Project Agents

@agents/README.md
EOF

    cat > agents/README.md << 'EOF'
# Agents

Project-specific agents for this repository.

## Available Agents

See `agents/*.md` files in this directory.

## Agent File Format

All agents follow the Claude Code standard format with YAML frontmatter:

```markdown
---
name: agent-identifier
description: Use this agent when [conditions]. Examples:

<example>
Context: [Situation]
user: "[Request]"
assistant: "[Response]"
<commentary>
[Why this agent triggers]
</commentary>
</example>

model: inherit
color: blue
tools: ["Read", "Write", "Bash", "Grep"]
---

[System prompt content]
```

## Usage

### Claude Code

Agents are auto-discovered when using the plugin:

```sh
claude --plugin-dir .
```

### Cursor IDE

Reference agents with `@agents/<agent>.md`

## Global Agents

Additional agents and skills are available from `~/ai`. See `.cursor/rules/global-agents/` for references.
EOF

    cat > agents/agent-template.md << 'EOF'
---
name: agent-name
description: Use this agent when [conditions]. Examples:

<example>
Context: [Situation]
user: "[Request]"
assistant: "[Response]"
<commentary>
[Why this agent triggers]
</commentary>
</example>

model: inherit
color: blue
tools: ["Read", "Write", "Bash", "Grep"]
---

# Agent Name

[System prompt content - describe what this agent does and how it should behave]

## Responsibilities

- [Responsibility 1]
- [Responsibility 2]

## Guidelines

- [Guideline 1]
- [Guideline 2]
EOF

    cat > AGENTS.md << 'EOF'
# Project Instructions

## IDE Setup

### Claude Code

Global settings from `~/ai` are automatically loaded via shell function:

```sh
claude   # Automatically uses --plugin-dir ~/ai
```

For project-specific agents, add the local plugin:

```sh
claude --plugin-dir ~/ai --plugin-dir .
```

### Cursor IDE

- Global rules: Maintained in `~/ai/settings/rules.md` (not duplicated here)
- Project agents: Reference with `@agents/<agent>.md`

## Available Agents

See `agents/*.md` files.

## Directory Structure

```
project/
├── .cursor/                  # Reusable template
│   └── rules/
│       ├── global-agents/
│       │   └── RULE.md       # References ~/ai (always applied)
│       └── project-agents/
│           └── RULE.md       # References agents/README.md
├── agents/                   # Project-specific agents
│   ├── README.md             # Agent documentation
│   └── agent-template.md     # Template for new agents
├── AGENTS.md                 # This file
└── CLAUDE.md                 # Entry point
```

## Global Resources

@~/ai/README.md

## Notes for AI Assistants

- Check agent descriptions to understand when to invoke them
- Follow coding standards from `~/ai/settings/rules.md`
EOF

    cat > CLAUDE.md << 'EOF'
@AGENTS.md
EOF

    echo "Created Cursor boilerplate:"
    echo "  .cursor/rules/global-agents/RULE.md"
    echo "  .cursor/rules/project-agents/RULE.md"
    echo "  agents/README.md"
    echo "  agents/agent-template.md"
    echo "  AGENTS.md"
    echo "  CLAUDE.md"
}
alias addagenticworkflow='addCursorBoilerplate'
alias addagentfiles='addCursorBoilerplate'
alias addagents='addCursorBoilerplate'
alias newagenticworkflow='addCursorBoilerplate'
alias newagentfiles='addCursorBoilerplate'
alias addcursorboilerplate='addCursorBoilerplate'
alias newcursorboilerplate='addCursorBoilerplate'
alias cursorrules='addCursorBoilerplate'
alias cursorboilerplate='addCursorBoilerplate'
alias newcursorfiles='addCursorBoilerplate'
alias addcursorfiles='addCursorBoilerplate'
alias addnewagents='addCursorBoilerplate'
alias newagents='addCursorBoilerplate'
alias newagent='addCursorBoilerplate'
alias addnewagent='addCursorBoilerplate'
alias newlocalagents='addCursorBoilerplate'
alias createlocalagents='addCursorBoilerplate'
alias createnewlocalagents='addCursorBoilerplate'